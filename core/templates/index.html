<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeaSphere | AI Health Orchestration</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.6); }
        .risk-ring { transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Map Container Height Fix */
        #map { 
            height: 300px; 
            width: 100%; 
            border-radius: 1rem; 
            z-index: 1; 
        }
        
        /* Custom Ambulance Icon Styling */
        .ambulance-icon { 
            font-size: 28px; 
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
            transition: all 0.5s linear;
        }
        
        /* Typewriter Cursor */
        .typing::after { content: '|'; animation: blink 1s infinite; color: #2563eb; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Modal Transition */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen text-slate-800">

    <nav class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200">
                <span class="text-white font-bold text-xl">H</span>
            </div>
            <div>
                <span class="text-2xl font-bold tracking-tight">Hea<span class="text-blue-600">Sphere</span></span>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Orchestration OS v2.1</p>
            </div>
        </div>
        <div id="dispatchStatus" class="px-4 py-2 bg-slate-100 rounded-full text-xs font-bold text-slate-500 shadow-sm border border-slate-200 flex items-center transition-all duration-500">
            <span class="w-2 h-2 rounded-full bg-slate-400 mr-2" id="statusDot"></span>
            <span id="statusText">System Idle</span>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto grid lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-5">
            <section class="glass rounded-3xl p-6 shadow-sm border-t-4 border-blue-600">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Input Signals</h2>
                    <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded font-bold">LIVE INPUT</span>
                </div>
                
                <form id="healthForm" class="space-y-4">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] uppercase font-bold text-slate-400">Current BMI</label>
                            <input type="number" step="0.1" id="bmi_current" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g. 28.5" required>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] uppercase font-bold text-slate-400">Past BMI (2yr)</label>
                            <input type="number" step="0.1" id="bmi_past" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-slate-700" placeholder="e.g. 26.0" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] uppercase font-bold text-slate-400">Age</label>
                            <input type="number" id="age" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-slate-700" value="55">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] uppercase font-bold text-slate-400">BP History</label>
                            <select id="high_bp" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-slate-700">
                                <option value="0">Normal</option>
                                <option value="1">Hypertension</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-2 pt-2">
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                            <span>Subjective Well-being</span>
                            <span id="healthVal" class="text-blue-600 text-lg">3</span>
                        </div>
                        <input type="range" id="health_current" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        <div class="flex justify-between text-[9px] text-slate-300 font-bold uppercase">
                            <span>Excellent</span>
                            <span>Critical</span>
                        </div>
                    </div>

                    <input type="hidden" id="health_past" value="2.0">
                    <input type="hidden" id="dep_current" value="2.0">
                    <input type="hidden" id="dep_past" value="1.0">

                    <button type="submit" id="btnText" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-2xl shadow-xl transition-all active:scale-95 flex justify-center items-center group">
                        <span>Run Analysis</span>
                        <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </form>
            </section>

            <section class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                <h3 class="text-xs font-bold mb-3 flex items-center text-slate-800">
                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Fairness & Ethics Audit
                </h3>
                <div class="text-[10px] text-slate-500 space-y-2">
                    <div class="flex justify-between">
                        <span>Gender Parity:</span>
                        <span class="font-bold text-slate-700">98.2% Match (39% vs 33%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Safety Protocol:</span>
                        <span class="font-bold text-green-600">Non-Diagnostic Mode</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mt-2">
                        <div class="bg-green-500 h-full rounded-full" style="width: 100%"></div>
                    </div>
                </div>
            </section>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div id="results" class="space-y-6 hidden">
                <div class="grid md:grid-cols-3 gap-6">
                    
                    <div class="glass rounded-3xl p-6 flex flex-col items-center justify-center relative overflow-hidden">
                        <div class="relative w-32 h-32 mb-4">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="8"/>
                                <circle id="riskPath" cx="50" cy="50" r="45" fill="none" stroke="#2563eb" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" class="risk-ring"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="scoreText" class="text-3xl font-bold text-slate-900">0%</span>
                                <span class="text-[9px] uppercase font-bold text-slate-400">Anomaly Score</span>
                            </div>
                        </div>
                        <div id="categoryBadge" class="px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest bg-blue-50 text-blue-600 border border-blue-100">Stable</div>
                    </div>

                    <div class="glass rounded-3xl p-6 md:col-span-2">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 flex justify-between">
                            <span>Hidden Signal Drivers (SHAP)</span>
                            <span class="text-blue-600 cursor-pointer hover:underline">View Details</span>
                        </h3>
                        <div id="shapBars" class="space-y-3">
                            </div>
                    </div>

                    <div class="md:col-span-3 glass rounded-3xl p-6 border-l-4 border-blue-600 shadow-sm relative overflow-hidden">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-sm text-slate-800">Hea Assistant</h3>
                                    <p class="text-[10px] text-slate-400">AI Context Triage</p>
                                </div>
                            </div>
                            <div class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded" id="etaDisplay">Standby</div>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100">
                            <p id="followUp" class="text-slate-700 text-sm leading-relaxed typing"></p>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="openModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl text-xs font-bold shadow-md transition-all flex justify-center items-center">
                                Locate Specialist
                            </button>
                            <button onclick="window.location.reload()" class="px-6 py-2.5 bg-white border border-slate-200 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-50">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-3xl p-1.5 shadow-md relative group">
                    <div id="map"></div>
                    <div class="absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow-sm border border-slate-100 z-[400]">
                        <div class="flex items-center space-x-2">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                            </span>
                            <span class="text-[10px] font-bold text-slate-600 uppercase">Live Dispatch</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="welcome" class="glass rounded-3xl h-96 flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-slate-200">
                <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-4 animate-bounce">
                    <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Orchestration System Online</h2>
                <p class="text-slate-400 text-sm mt-2 max-w-xs">Input patient vitals to activate the HeaSphere anomaly detection and logistics engine.</p>
                <button onclick="triggerDemo()" class="mt-6 text-xs text-slate-400 font-bold hover:text-blue-600 underline">Run Demo Scenario</button>
            </div>
        </div>
    </main>

    <div id="specialistModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[1000] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl transform scale-95 opacity-0 transition-all duration-300" id="modalContent">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Triage Match</h3>
                    <p class="text-xs text-slate-400">Based on Metabolic Risk Score</p>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-xl">âœ•</button>
            </div>
            
            <div class="space-y-3">
                <div class="flex items-center p-3 bg-slate-50 rounded-xl border border-slate-100 hover:border-blue-200 transition cursor-pointer group">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold mr-3">DA</div>
                    <div class="flex-1">
                        <h4 class="text-sm font-bold text-slate-800 group-hover:text-blue-600">Dr. Ade Johnson</h4>
                        <p class="text-[10px] text-slate-500">Endocrinologist â€¢ UCH Ibadan</p>
                    </div>
                    <span class="text-[10px] font-bold bg-green-100 text-green-600 px-2 py-1 rounded">Available</span>
                </div>
                <div class="flex items-center p-3 bg-slate-50 rounded-xl border border-slate-100 hover:border-blue-200 transition cursor-pointer group">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold mr-3">CO</div>
                    <div class="flex-1">
                        <h4 class="text-sm font-bold text-slate-800 group-hover:text-blue-600">Dr. Chidi Okafor</h4>
                        <p class="text-[10px] text-slate-500">Cardiologist â€¢ Lagoon Hospital</p>
                    </div>
                    <span class="text-[10px] font-bold bg-yellow-100 text-yellow-600 px-2 py-1 rounded">15m Wait</span>
                </div>
            </div>
            
            <button onclick="closeModal()" class="w-full mt-6 bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-xl font-bold text-sm transition">Confirm Appointment</button>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        let map, ambulanceMarker;
        const startCoords = [7.3775, 3.9470]; // Ibadan Center
        
        // --- 2. SLIDER LOGIC ---
        document.getElementById('health_current').oninput = function() { 
            document.getElementById('healthVal').innerText = this.value; 
        }

        // --- 3. MAP LOGIC (LEAFLET) ---
        function initMap() {
            if (map) return;
            
            // Initialize Map
            map = L.map('map', { zoomControl: false }).setView(startCoords, 14);
            
            // Professional Tile Layer (CartoDB Light) - NO API KEY NEEDED
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            // Patient Marker
            const userIcon = L.divIcon({
                className: 'user-marker',
                html: '<div style="background:#2563eb; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow:0 0 0 10px rgba(37,99,235,0.2);"></div>',
                iconSize: [20, 20]
            });
            L.marker(startCoords, {icon: userIcon}).addTo(map).bindPopup("Patient Location").openPopup();
        }

        function dispatchAmbulance() {
            // Check if map is ready
            if (!map) initMap();

            // Create Ambulance Icon
            const ambIcon = L.divIcon({
                className: 'ambulance-icon',
                html: 'ðŸš‘',
                iconSize: [30, 30]
            });

            // Start Position (Offset from user)
            const ambStart = [startCoords[0] + 0.02, startCoords[1] + 0.02];
            if(ambulanceMarker) map.removeLayer(ambulanceMarker);
            ambulanceMarker = L.marker(ambStart, {icon: ambIcon}).addTo(map);

            // Animate Movement
            let steps = 0;
            const maxSteps = 100;
            const interval = setInterval(() => {
                steps++;
                const lat = ambStart[0] + (startCoords[0] - ambStart[0]) * (steps / maxSteps);
                const lng = ambStart[1] + (startCoords[1] - ambStart[1]) * (steps / maxSteps);
                ambulanceMarker.setLatLng([lat, lng]);
                
                if (steps >= maxSteps) clearInterval(interval);
            }, 50);
        }

        // --- 4. FORM SUBMISSION ---
        const form = document.getElementById('healthForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnText');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Analyzing...';
            btn.disabled = true;

            const payload = {
                age: parseFloat(document.getElementById('age').value),
                high_bp: parseInt(document.getElementById('high_bp').value),
                bmi_current: parseFloat(document.getElementById('bmi_current').value),
                bmi_past: parseFloat(document.getElementById('bmi_past').value),
                health_current: parseFloat(document.getElementById('health_current').value),
                health_past: 2.0,
                depression_current: 2.0,
                depression_past: 1.0
            };

            try {
                // Determine CSRF Token (Handle if template tag fails)
                let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '';

                const response = await fetch('/api/analyze/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                if(data.status === 'success') {
                    updateUI(data.analysis, payload);
                } else {
                    alert("System Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                // Fallback for Demo if server fails
                alert("Server Connection Failed. Running Local Simulation Mode.");
                triggerDemo(); 
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- 5. UI UPDATE LOGIC ---
        function updateUI(res, inputs) {
            document.getElementById('welcome').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            // Fix Leaflet Map Size (Must happen after container is visible)
            setTimeout(() => {
                initMap();
                map.invalidateSize();
            }, 100);

            // Update Gauge
            const pct = res.risk_score * 100;
            const offset = 283 - (283 * pct / 100);
            const path = document.getElementById('riskPath');
            path.style.strokeDashoffset = offset;
            path.style.stroke = pct > 60 ? '#dc2626' : (pct > 40 ? '#f59e0b' : '#2563eb');
            document.getElementById('scoreText').innerText = Math.round(pct) + "%";

            // Update SHAP Bars
            const shapBox = document.getElementById('shapBars');
            shapBox.innerHTML = '';
            const drivers = [
                {label: 'Metabolic Velocity', val: Math.abs((inputs.bmi_current - inputs.bmi_past) * 45)},
                {label: 'Subjective Decline', val: Math.abs((inputs.health_current - 2.0) * 20)},
                {label: 'Cardiovascular', val: inputs.high_bp == 1 ? 60 : 15},
                {label: 'Age Vector', val: inputs.age * 0.5}
            ].sort((a,b) => b.val - a.val);

            drivers.forEach(d => {
                shapBox.innerHTML += `
                    <div class="space-y-1">
                        <div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase">
                            <span>${d.label}</span><span>${Math.round(d.val)}% Impact</span>
                        </div>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-blue-600 h-full rounded-full transition-all duration-1000 ease-out" style="width: ${Math.min(100, d.val)}%"></div>
                        </div>
                    </div>`;
            });

            // Typewriter Effect for Assistant
            const typeBox = document.getElementById('followUp');
            typeBox.innerText = "";
            let i = 0;
            const txt = res.follow_up;
            function typeWriter() {
                if (i < txt.length) {
                    typeBox.innerHTML += txt.charAt(i);
                    i++;
                    setTimeout(typeWriter, 15);
                }
            }
            typeWriter();

            // Emergency Logic
            const dStatus = document.getElementById('dispatchStatus');
            const dText = document.getElementById('statusText');
            const dDot = document.getElementById('statusDot');
            const eta = document.getElementById('etaDisplay');

            if (pct > 60) {
                eta.innerText = "ETA: 4 MINS";
                eta.className = "text-[10px] font-bold bg-red-100 text-red-600 px-2 py-1 rounded uppercase animate-pulse";
                dText.innerText = "EMERGENCY DISPATCHED";
                dStatus.className = "px-4 py-2 bg-red-600 rounded-full text-xs font-bold text-white shadow-lg animate-pulse flex items-center";
                dDot.className = "w-2 h-2 rounded-full bg-white mr-2 animate-ping";
                
                dispatchAmbulance(); // Run Map Animation
            } else {
                eta.innerText = "Monitoring";
                eta.className = "text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded uppercase";
                dText.innerText = "System Monitoring";
                dStatus.className = "px-4 py-2 bg-slate-100 rounded-full text-xs font-bold text-slate-500 shadow-sm border border-slate-200 flex items-center";
                dDot.className = "w-2 h-2 rounded-full bg-green-500 mr-2";
            }
        }

        // --- 6. MODAL LOGIC ---
        function openModal() {
            const modal = document.getElementById('specialistModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        function closeModal() {
            const modal = document.getElementById('specialistModal');
            const content = document.getElementById('modalContent');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- 7. DEMO HELPER (FOR JUDGES) ---
        function triggerDemo() {
            document.getElementById('bmi_current').value = 35;
            document.getElementById('health_current').value = 5;
            document.getElementById('high_bp').value = 1;
            document.getElementById('btnText').click();
        }
    </script>
</body>
</html>